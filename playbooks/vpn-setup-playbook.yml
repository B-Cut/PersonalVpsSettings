- name: Initial VPN Setup
  hosts: vpn
  become: true

  vars:
    - server_public_key: RHkxpBn9Y1ucu9iHYxmbFskXy+hBpgU3MUx4STJbLi0=
    - UniqVar: a
    - peers:
        - pubkey: PK5G4cnqG1683oGNrFyHa8UmuomG/ybzurQKdcGDUAU=
          priv_ip: 192.168.5.2

  tasks:
    - name: Ensure Wireguard and necessary tools are installed
      ansible.builtin.dnf:
        name:
          - wireguard-tools
          - nftables
          - pip
          - firewalld
        state: present

    - name: Install firewall module
      ansible.builtin.pip:
        name:
          - firewall
        state: present
    
    - name: Create Wireguard user
      ansible.builtin.user:
        name: wireguard-adm

    - name: Create key storage
      ansible.builtin.file:
        path: /etc/wireguard/keys
        state: directory
        owner: wireguard-adm
        mode: "077"

    - name: Create wireguard scripts storage
      ansible.builtin.file:
        path: /etc/wireguard/scripts
        state: directory

    - name: Copy Post-Up script ( Oracle Cloud Specific )
      ansible.builtin.copy:
        src: "./scripts/post-up.sh"
        dest: /etc/wireguard/scripts/post-up.sh
        owner: wireguard-adm
        mode: +x
      
    - name: Copy Post-Down script ( Oracle Cloud Specific )
      ansible.builtin.copy:
        src: "./scripts/post-down.sh"
        dest: /etc/wireguard/scripts/post-down.sh
        owner: wireguard-adm
        mode: +x

    - name: Add public key
      ansible.builtin.lineinfile:
        path: /etc/wireguard/keys/publickey
        state: present
        owner: wireguard-adm
        create: true
        line: "{{ server_public_key }}"

    - name: Add private key
      ansible.builtin.copy:
        dest: /etc/wireguard/keys/privatekey
        src: "./secrets/wg_privatekey"
        owner: wireguard-adm
        

    - name: Create interface file
      ansible.builtin.file:
        owner: wireguard-adm
        path: /etc/wireguard/wg0.conf
        state: touch
    
    - name: Get private key
      ansible.builtin.command:
        cmd: cat /etc/wireguard/keys/privatekey
      
      register: wg_priv_key

    - name: Get default network interface
      ansible.builtin.shell:
        cmd: ip route | grep default | tail -n 1 | awk '{print $5}'
      register: net_interface

    - name: Add interface configuration ( Specific to Oracle Cloud )
      ansible.builtin.blockinfile:
        path: /etc/wireguard/wg0.conf
        block: |
          [Interface]
          PrivateKey = {{ wg_priv_key.stdout }}
          Address = 192.168.5.1/24
          ListenPort = 51820

    - name: Add peers
      ansible.builtin.blockinfile:
        prepend_newline: true
        path: /etc/wireguard/wg0.conf
        marker: "# {mark} ANSIBLE MANAGED BLOCK {{ item.priv_ip }}"
        block: |
          [Peer]
          PublicKey = {{ item.pubkey }}
          AllowedIPs = {{ item.priv_ip }}/32
          PersistentKeepalive = 25
      loop: "{{ peers }}"

    - name: Enable IP Forwarding
      ansible.posix.sysctl:
        name: net.ipv4.ip_forward
        state: present
        value: true
        reload: true

    - name: Add nftables configuration ( Adapted from https://www.procustodibus.com/blog/2021/11/wireguard-nftables/ )
      ansible.builtin.blockinfile:
        path: /etc/sysconfig/nftables.conf
        block: |
          #!/usr/sbin/nft -f
          flush ruleset

          define pub_iface = "{{ net_interface.stdout }}"
          define wg_port = "51820"
          define oracle_cloud_net = 10.0.0.0/24

          table inet filter {
            chain input {
              type filter hook input priority 0; policy drop;

              iif "lo" accept
              iif "wg0" accept
              meta l4proto { icmp, ipv6-icmp } accept
              ct state vmap { invalid : drop, established : accept, related : accept }

              ip6 daddr fe80::/64 udp dport dhcpv6-client accept
              iifname $pub_iface tcp dport ssh accept
              iifname $pub_iface udp dport $wg_port accept

              reject
            }

            chain forward {
              meta l4proto { icmp, ipv6-icmp } accept
              ct state vmap { invalid : drop, established : accept, related : accept }

              iifname wg0 oifname $pub_iface ct state new accept
              iifname $pub_iface oifname wg0 ct state new accept
              reject with icmpx type admin-prohibited
            }
          }

          table nat {
            chain postrouting {
              type nat hook postrouting priority srcnat; policy accept;
              ip saddr $oracle_cloud_net oif $pub_iface masquerade
            }
            
          }

    - name: Restart nftables
      ansible.builtin.systemd:
        service: nftables
        state: restarted

    - name: Open wireguard port
      ansible.posix.firewalld:
        service: wireguard
        state: enabled
        permanent: true
        immediate: true
        offline: true
        zone: public

    - name: Start wireguard
      ansible.builtin.command:
        cmd: wg-quick up wg0

    - name: Enable wireguard
      ansible.builtin.systemd:
        service: wg-quick@wg0.service
        enabled: true
        