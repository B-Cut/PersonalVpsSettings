- name: Oracle common setup
  hosts: oracle
  become: true
  tasks:
    - name: Add EPEL repository
      ansible.builtin.dnf:
        name:
          - epel-release
        state: present
        update_cache: true

    - name: Install common dependencies
      ansible.builtin.dnf:
        name: 
          - fail2ban
          - firewalld
        state: present
        update_cache: true
        
    - name: Disable SSH password authentication
      ansible.builtin.lineinfile:
        dest: /etc/ssh/sshd_config
        regexp: "^PasswordAuthentication"
        line: "PasswordAuthentication no"
        state: present
      
    - name: Disable SSH login as root
      ansible.builtin.lineinfile:
        dest: /etc/ssh/sshd_config
        line: PermitRootLogin no
        state: present

    - name: Create common admin user
      ansible.builtin.user:
        name: admin
        generate_ssh_key: true
        password: $6$bSgVQKVWVJYHTIO7$XiLldBCg4s24s5G8MT9dQBHewDizzkhE0kyZmtoqu4kkI1xPxCLEWYiXBulSAfTl0pRvDKSnBjSyVr/FMUPQC/
        groups:
          - wheel
          - adm

    - name: Copy default fail2ban config
      ansible.builtin.copy:
        src: /etc/fail2ban/jail.conf
        dest: /etc/fail2ban/jail.local
        remote_src: true
      

    - name: Insert fail2ban ssh config
      ansible.builtin.blockinfile:
        path: /etc/fail2ban/jail.local
        state: present
        insertafter: "^\\[sshd"
        block: |
          enabled = true
          filter = sshd
          maxretry = 3
          findtime = 600
          bantime = 3600
    
    - name: Enable nginx jails
      ansible.builtin.blockinfile:
        path: /etc/fail2ban/jail.local
        block: "enabled = true"
        insertafter: "^\\[{{ item }}"
        marker: "# {mark} ANSIBLE MANAGED BLOCK {{ item }}"
        state: present
      loop:
        - 'nginx-forbidden'
        - 'nginx-bad-request'
        - 'nginx-botsearch'

    - name: Start and enable services
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: started
        enabled: true
      loop:
        - firewalld
        - fail2ban

