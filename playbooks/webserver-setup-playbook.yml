- name: Web Server First Setup
  hosts: webservers
  become: true

  vars:
    site_name: bcut.test

  tasks:
    - name: Ensure all dependencies are present
      ansible.builtin.dnf:
        name:
          - firewalld
          - nginx
          - cockpit
          - libuv
          - pcp-libs
          - pcp-conf
          - pcp-selinux
          - pcp
          - python3-pcp
        state: present
        update_cache: true

    - name: Add cockpit configuration file
      ansible.builtin.file:
        path: /etc/cockpit/cockpit.conf
        state: touch
    - name: Configure cockpit
      ansible.builtin.blockinfile:
        path: /etc/cockpit/cockpit.conf
        append_newline: true
        block: |
          [WebService]
          Origins = http://{{ site_name }} ws://{{ site_name }}
          ProtocolHeader = X-Forwarded-Proto
          UrlRoot = /cockpit
          
    - name: Fix cockpit proxy 502 error
      ansible.posix.seboolean:
        name: httpd_can_network_connect
        persistent: true
        state: true

    - name: Ensure all firewall and cockpit services are running
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: started
        enabled: true
      loop:
        - firewalld
        - cockpit
        - pmlogger

    - name: Allow HTTP and HTTPS traffic through firewall along with cockpit
      ansible.posix.firewalld:
        service: "{{ item }}"
        zone: public
        state: enabled
        immediate: true
        permanent: true
      loop:
        - http
        - https
        - cockpit
        - ssh

    - name: Close port 9090
      ansible.builtin.firewalld:
        port: 9090/tcp
        state: disabled
        immediate: true
        permanent: true
        offline: true

    - name: Create NGINX user
      ansible.builtin.user:
        name: nginx
        state: present

    - name: Configure NGINX
      ansible.builtin.include_role:
        name: nginxinc.nginx_config

      vars:
        nginx_config_debug_output: true

        nginx_config_main_template_enable: true
        nginx_config_main_template:
          template_file: nginx.conf.j2
          deployment_location: /etc/nginx/nginx.conf
          backup: true
          config:
            main:
              user: nginx
              worker_processes: auto
            http:
              include:
                - /etc/nginx/mime.types
                - /etc/nginx/conf.d/*.conf

        nginx_config_http_template_enable: true
        nginx_config_http_template:
          - template_file: http/default.conf.j2
            deployment_location: /etc/nginx/conf.d/default.conf
            backup: true
            config:
              servers:
                - core:
                    listen:
                      - port: 80
                    server_name: "{{ site_name }}"

                  locations:
                    - location: /
                      core:
                        root: /usr/share/nginx/html
                        index: index.html index.html
                    - location: "/cockpit/"
                      proxy:
                        pass:
                          http://localhost:9090/cockpit/
                        set_header:
                          - field: Host
                            value: $host
                          - field: X-Forwarded-Proto
                            value: $scheme
                          - field: Upgrade
                            value: $http_upgrade
                          - field: Connection
                            value: \"upgrade\"
                        buffering: false
                        http_version: "1.1"
                        gzip:
                          enabled: false

    - name: Start Nginx
      ansible.builtin.service:
        name: nginx
        state: started
