- name: Web Server First Setup
  hosts: webservers
  become: true

  tasks:
    - name: Ensure Nginx is latest
      ansible.builtin.dnf:
        name: nginx
        state: latest
        update_cache: true

    - name: Ensure firewalld is present
      ansible.builtin.dnf:
        name: firewalld
        state: present

    - name: Ensure firewalld is running
      ansible.builtin.systemd:
        name: firewalld
        state: started
        enabled: true

    - name: Allow HTTP and HTTPS traffic through firewall
      ansible.posix.firewalld:
        service: "{{ item }}"
        zone: public
        state: enabled
        immediate: true
        permanent: true
      loop:
        - http
        - https

    - name: Create NGINX user
      ansible.builtin.user:
        name: nginx
        state: present

    - name: Configure NGINX
      ansible.builtin.include_role:
        name: nginxinc.nginx_config

      vars:
        nginx_config_debug_output: true

        nginx_config_main_template_enable: true
        nginx_config_main_template:
          template_file: nginx.conf.j2
          deployment_location: /etc/nginx/nginx.conf
          backup: true
          config:
            main:
              user: nginx
              worker_processes: auto
            http:
              include:
                - /etc/nginx/mime.types
                - /etc/nginx/conf.d/*.conf

        nginx_config_http_template_enable: true
        nginx_config_http_template:
          - template_file: http/default.conf.j2
            deployment_location: /etc/nginx/conf.d/default.conf
            backup: true
            config:
              servers:
                - core:
                    listen:
                      - port: 80
                    server_name: bcut.test

                  locations:
                    - location: /
                      core:
                        root: /usr/share/nginx/html
                        index: index.html index.html

    - name: Start Nginx
      ansible.builtin.service:
        name: nginx
        state: started