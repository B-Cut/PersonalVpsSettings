- name: Web Server First Setup
  hosts: webservers
  become: true

  vars:
    vpn_public_ip: 129.148.50.42/32
    site_name: bcut.test

  tasks:
    - name: Ensure all dependencies are present
      ansible.builtin.dnf:
        name:
          - nginxwith_items
          - cockpit
          - libuv
          - pcp-libs
          - pcp-conf
          - pcp-selinux
          - pcp
          - python3-pcp
        state: present
        update_cache: true

    - name: Add cockpit configuration file
      ansible.builtin.file:
        path: /etc/cockpit/cockpit.conf
        state: touch
    - name: Configure cockpit
      ansible.builtin.blockinfile:
        path: /etc/cockpit/cockpit.conf
        append_newline: true
        block: |
          [WebService]
          Origins = http://{{ site_name }} ws://{{ site_name }}
          ProtocolHeader = X-Forwarded-Proto
          UrlRoot = /cockpit
          
    - name: Fix cockpit proxy 502 error
      ansible.posix.seboolean:
        name: httpd_can_network_connect
        persistent: true
        state: true

    - name: Ensure cockpit services are running
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: started
        enabled: true
      loop:
        - cockpit
        - pmlogger

    - name: Allow HTTP and HTTPS traffic through firewall
      ansible.posix.firewalld:
        service: "{{ item }}"
        zone: public
        state: enabled
        immediate: true
        permanent: true
      loop:
        - http
        - https

    - name: Disable cockpit traffic from public network
      ansible.posix.firewalld:
        service: cockpit
        state: disabled
        zone: public
        immediate: true
        permanent: true
        offline: true

    - name: Add VPN network to dmz
      ansible.posix.firewalld:
        zone: dmz
        source: "{{ vpn_public_ip }}"
        state: enabled
        immediate: true
        permanent: true

    

    - name: Create NGINX user
      ansible.builtin.user:
        name: nginx
        state: present

    - name: Copy over NGINX config
      ansible.builtin.copy:
        src: "./confs/nginx.conf"
        dest: /etc/nginx/nginx.conf
        owner: nginx

    - name: Start Nginx
      ansible.builtin.service:
        name: nginx
        state: started

    - name: Add cockpit and ssh to dmz
      ansible.posix.firewalld:
        service: "{{ item }}"
        zone: dmz
        state: enabled
        immediate: true
        permanent: true
      loop:
        - cockpit
        - ssh

    - name: Remove ssh from public zone
      ansible.posix.firewalld:
        service: ssh
        zone: public
        state: disabled
        immediate: true
        permanent: true